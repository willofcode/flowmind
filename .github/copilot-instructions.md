# FlowMind - AI Agent Instructions

## Project Mission
FlowMind is a **neurodivergent-friendly planning app** designed for ADHD, autistic, and dyslexic users. Every design decision prioritizes **cognitive load reduction**, **sensory awareness**, and **executive function support**. This is not a typical productivity app—it's therapeutic scaffolding.

## Architecture Overview

### Monorepo Structure
```
flowmind/
├── client/          # Expo/React Native iOS app (TypeScript)
├── server/          # Node.js/Express API (ES modules)
└── *.md             # Design docs (read DESIGN_PATTERNS.md for UX rules)
```

### Data Flow & Intelligent Scheduling Logic
```
iOS App (Expo) → Node Backend → Google Calendar (fetch schedule)
                              ↓
                    Analyze gaps & schedule intensity
                              ↓
                    NeuralSeek mAIstro (AI planning with context)
                    - Calculate schedule density
                    - Identify optimal windows for activities
                    - Adapt intensity based on workload
                    - Generate breathing/meditation sessions
                              ↓
                    Create events: workouts, meals, breaks, breathwork
                              ↓
                    Supabase (profiles, plans, sessions)
                    ElevenLabs TTS (guided audio sessions)
```

**Core Scheduling Algorithm:**
1. **Fetch existing commitments** from Google Calendar (FreeBusy API)
2. **Calculate schedule intensity** (gaps vs busy blocks ratio)
   - High intensity (>70% busy): Insert 5-10 min breathing breaks only
   - Medium intensity (40-70% busy): Add movement snacks + meals
   - Low intensity (<40% busy): Full workouts + meal prep + optional activities
3. **Respect energy windows** from `PersonalNeuroProfile.energyWindows`
4. **Apply buffer rules** (`bufferPolicy.before/after`) around all events
5. **Generate adaptive content**:
   - Breathing exercises during high-stress periods
   - Light movement during transition gaps
   - Full workouts during 60+ min windows in energy peaks
6. **Create calendar events** with 10-3-1 reminders via Google Calendar API

### Core Type System
All neurodivergent features flow from `client/types/neuro-profile.ts`:
- `PersonalNeuroProfile`: Energy windows, sensory prefs, buffer policies
- `TodayBlock`: Single-focus activity with 3-5 micro-steps
- `WeeklyPlan`: Generated by NeuralSeek with ADHD-aware constraints
- `BreathingSession`: TTS-guided meditation/breathing with ElevenLabs
- `ScheduleIntensity`: Calculated metric (low/medium/high) for adaptive planning

## Critical Design Constraints (NON-NEGOTIABLE)

### 1. Cognitive Load Rules
- **ONE thing at a time**: Today View shows ONLY next block (see `client/components/today-view.tsx`)
- **Max 2 choices**: A/B alternatives only, never dropdowns with 5+ options
- **Micro-steps required**: Every activity breaks into 3-5 concrete actions (not vague like "get ready")
- **Large touch targets**: 48px minimum, 56px preferred (see `CalmSpacing` in `client/constants/calm-theme.ts`)

### 2. Sensory Awareness
- **High contrast only**: WCAG AAA (7:1 ratio) via `CalmColors.light/dark`
- **Haptics over sound**: Use `expo-haptics` for feedback, never autoplay audio
- **Reduced motion mode**: Check `sensory.reducedAnimation` before any animation
- **Silent mode**: Respect `sensory.silentMode` in notifications (`client/lib/notification-manager.ts`)

### 3. Language & Tone
- **Gentle, not aggressive**: "Put on shoes" ✅ | "HURRY UP!" ❌
- **Concrete, not abstract**: "Fill water bottle" ✅ | "Prepare" ❌
- **No shame/guilt**: Skip buttons always visible, no streak shaming
- **Predictable timing**: 10-3-1 minute nudges (fixed pattern, no randomness)

## Development Workflows

### Running the App
```bash
# Terminal 1 - Backend (MODULAR ARCHITECTURE)
cd server && npm start  # Runs index.js on :3001

# Terminal 2 - iOS client
cd client && npm run ios  # Expo/React Native

# Terminal 3 - Test API (optional)
cd server && node test-new-api.js  # Comprehensive test suite
```

**Server Architecture:** The backend now uses a modular structure. See `server/ARCHITECTURE.md` for complete documentation.

### Environment Setup
- **Server**: Requires `server/.env` with `SUPABASE_URL`, `SUPABASE_ANON_KEY`, `NS_EMBED_CODE`
- **Client**: Requires `client/.env` with `EXPO_PUBLIC_API_BASE_URL=http://localhost:3001`
- **Database**: Run `server/user-schema.sql` in Supabase SQL Editor

### Key Commands
- `npm run ios` - Start Expo on iOS simulator (client folder)
- `npm start` - Start Node backend (server folder only)
- `expo install <pkg>` - Add Expo-compatible packages (not `npm install`)

## API Integration Patterns

### NeuralSeek (AI Planning & Mood Analysis)
- **Embed code auth**: Use `embedcode` header, NOT Bearer tokens
- **Two endpoints**: `/seek` (knowledge base queries) | `/maistro` (AI agent planning)
- **Critical parameter**: mAIstro requires `ntl` (natural language), NOT `prompt`
- **Mood analysis**: `analyzeMoodWithMaistro()` in `server/server-new-schema.js`
  - Input: User transcription, schedule density, neuro context
  - Output: Mood score (1-10), energy level, stress level, recommendations
- **Pattern discovery**: `discoverMoodPatterns()` finds correlations asynchronously
  - Analyzes last 30 mood check-ins + 4 weeks of schedules
  - Returns patterns with confidence scores
- **Response parsing**: Expects JSON format with structured mood data

### Supabase (Backend Storage)
- **User storage**: `users` table with email as primary identifier (Auth0 link optional)
- **Profile storage**: `user_profiles` table with JSONB for neuro preferences & personality
- **Mood tracking**: `mood_check_ins` table stores STT transcriptions + AI analysis
- **Schedule context**: `weekly_schedules` table with density metrics
- **Pattern discovery**: `mood_patterns` table stores AI-found correlations
- **Conversation history**: `conversations` table for mAIstro context
- **Client integration**: Use `@supabase/supabase-js` directly in client
- **Views**: `user_current_state` view provides complete user context in one query
- **RLS**: Disabled for development, requires policies for production

### Google Calendar (Required for Scheduling)
- **OAuth implementation status**: ⚠️ **NOT YET IMPLEMENTED** - Need to add OAuth flow
- **Current state**: Server endpoints exist, but client-side Google Sign-In is missing
- **Required setup**:
  1. Install `expo-auth-session`, `expo-crypto`, `expo-web-browser`
  2. Configure Google Cloud Console (OAuth 2.0 credentials)
  3. Implement sign-in flow in `client/lib/google-auth.ts`
  4. Store token in `expo-secure-store`
- **FreeBusy API**: Fetch existing commitments to calculate schedule intensity
- **Schedule intensity calculation**: 
  ```javascript
  intensity = busyMinutes / totalMinutes
  // >70% = high (breathing breaks only)
  // 40-70% = medium (movement + meals)
  // <40% = low (full workouts + meal prep)
  ```
- **Event creation**: Includes 10-3-1 reminders via `/create-events` endpoint
- **Gap analysis**: Identify windows ≥10 min for breathing, ≥30 min for meals, ≥60 min for workouts
- **Scopes needed**: 
  - `https://www.googleapis.com/auth/calendar.readonly` (read calendar)
  - `https://www.googleapis.com/auth/calendar.events` (create events)

### ElevenLabs TTS (Guided Sessions)
- **Voice generation**: Convert breathing/meditation scripts to audio
- **API endpoint**: `/generate-session-audio` in server
- **Caching**: Store generated audio in Supabase Storage to avoid regeneration
- **Script templates**: Predefined 5-min, 10-min, 15-min breathing guides
- **Integration**: Called when high-intensity schedule detected
- **Playback**: Use `expo-av` Audio API in client for session playback

## Code Patterns to Follow

### Client Components
```tsx
// Always respect calm UI preferences
const colors = colorScheme === 'dark' ? CalmColors.dark : CalmColors.light;
const { reducedAnimation, hapticsOnly } = profile.sensory;

// Haptic feedback on ALL interactions
const handlePress = async () => {
  await Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Medium);
  onAction();
};

// Large, clear CTAs
<Pressable style={{ height: 56, borderRadius: 12 }}>
```

### STT Mood Check-in Component
```tsx
import MoodCheckInSTT from '@/components/mood-checkin-stt';

// Voice-based mood tracking with AI analysis
<MoodCheckInSTT
  userId="user-uuid"
  onComplete={(data) => {
    console.log('Transcription:', data.transcription);
    console.log('Mood score:', data.moodScore);
    console.log('Recommendations:', data.recommendations);
  }}
  onCancel={() => router.back()}
/>
```

**Key Features:**
- Audio recording with `expo-av`
- Pulsing animations (respects `reducedAnimation`)
- Real-time timer display
- Haptic feedback on record/stop
- Mock transcription (replace with OpenAI Whisper/iOS Speech Recognition)
- Sends to backend → mAIstro analysis → returns mood + recommendations

### Server Endpoints
```javascript
// Always catch errors and log
try {
  const response = await fetch(NS_MAISTRO_ENDPOINT, {
    headers: { "embedcode": NS_EMBED_CODE },
    body: JSON.stringify({ ntl: prompt, context, parameters }) // Use ntl, not prompt!
  });
  if (!response.ok) throw new Error(`API error: ${response.statusText}`);
} catch (err) {
  console.error("Endpoint error:", err);
  res.status(500).json({ error: err.message });
}

// Example: Mood check-in endpoint
app.post("/mood-checkin", async (req, res) => {
  const { userId, transcription, audioUrl, durationSeconds } = req.body;
  
  // 1. Get schedule context
  const { data: schedule } = await supabase
    .from("weekly_schedules")
    .select("avg_daily_density")
    .eq("user_id", userId)
    .single();
  
  // 2. Call mAIstro for mood analysis
  const analysis = await analyzeMoodWithMaistro({
    transcription,
    userId,
    scheduleDensity: schedule?.avg_daily_density > 0.7 ? 'high' : 'medium'
  });
  
  // 3. Save to database
  const { data } = await supabase
    .from("mood_check_ins")
    .insert({ user_id: userId, transcription, mood_score: analysis.moodScore, ... });
  
  // 4. Trigger async pattern discovery
  discoverMoodPatterns(userId);
  
  res.json({ success: true, checkIn: data, recommendations: analysis.recommendations });
});
```

### Profile Management
```typescript
// Local-first with cloud sync
import { saveProfile, loadProfile } from '@/lib/profile-store';
await saveProfile(profile); // Saves to expo-secure-store
await apiClient.saveProfileToServer(profile, userId); // Syncs to Supabase
```

## Common Mistakes to Avoid

1. **❌ Adding animations without checking `reducedAnimation` flag**
   - ✅ Check `profile.sensory.reducedAnimation` before any `Animated` API usage

2. **❌ Using icon-only buttons**
   - ✅ Always include text labels (accessibility + ADHD clarity)

3. **❌ Multiple CTAs on same screen**
   - ✅ One primary action per view (Today View pattern)

4. **❌ Generic error messages**
   - ✅ Specific, actionable errors: "Unable to connect to calendar. Try again?" 

5. **❌ Breaking micro-steps into sub-steps**
   - ✅ 3-5 steps max per activity, each takes 1-5 minutes

6. **❌ Using `npm install` in client**
   - ✅ Use `expo install` or `npx expo install` for Expo packages

## Testing & Debugging

### Testing Strategy
- **Unit tests**: Test schedule intensity calculation logic in isolation
- **Profile testing**: Use `defaultProfile` from `client/lib/profile-store.ts` for rapid testing
- **API mocking**: Mock NeuralSeek/ElevenLabs responses for offline development
- **Schedule scenarios**: Test with high/medium/low intensity calendars
- **Breathing session testing**: Verify audio generation and playback with test scripts

### Server Health Check
```bash
curl http://localhost:3001/health
# Returns NeuralSeek + Supabase + ElevenLabs status
```

### Notification Testing
10-3-1 system logs to console. Check `client/lib/notification-manager.ts` for schedule logic.

### Schedule Intensity Testing
```javascript
// Example test cases in server
const testCases = [
  { busyMinutes: 480, totalMinutes: 600, expected: 'high' },    // 80% busy
  { busyMinutes: 300, totalMinutes: 600, expected: 'medium' },  // 50% busy
  { busyMinutes: 180, totalMinutes: 600, expected: 'low' }      // 30% busy
];
```

## Key Files Reference

| File | Purpose | When to Edit |
|------|---------|--------------|
| `client/types/neuro-profile.ts` | Core data types | Adding new profile fields |
| `client/lib/api-client.ts` | Backend API wrapper | New server endpoints |
| `client/lib/profile-store.ts` | Local storage + defaults | Profile schema changes |
| `client/components/today-view.tsx` | Main UX component | Today screen changes |
| `client/components/mood-checkin-stt.tsx` | Voice mood check-in | STT recording logic |
| `client/constants/calm-theme.ts` | Design tokens | Colors, spacing, typography |
| `server/server.js` | Legacy backend (deprecated) | DO NOT USE - Use server-new-schema.js |
| `server/server-new-schema.js` | **Current backend** | All API endpoints, mAIstro orchestration |
| `server/user-schema.sql` | **Current database schema** | User-centric tables, views, functions |
| `DESIGN_PATTERNS.md` | UX rules & rationale | Understanding neurodivergent design |
| `STT_INTEGRATION_GUIDE.md` | Voice transcription guide | Implementing STT services |
| `IMPLEMENTATION_COMPLETE.md` | Complete architecture docs | Understanding new system |

## Database Schema & Migrations

### Current Tables (User-Centric Architecture)
```sql
-- Core user management
users (id, email, name, auth0_sub [optional], created_at, updated_at)

-- Neurodivergent preferences & personality
user_profiles (user_id, display_name, neuro_preferences JSONB, personality_traits JSONB)

-- STT mood check-ins with AI analysis
mood_check_ins (id, user_id, check_in_date, transcription, mood_score, energy_level, 
                stress_level, emotional_state JSONB, schedule_density, ai_analysis JSONB)

-- Weekly schedule context
weekly_schedules (id, user_id, week_start, week_end, total_events, total_minutes, 
                  avg_daily_density, daily_breakdown JSONB)

-- AI-discovered mood-schedule correlations
mood_patterns (id, user_id, pattern_type, pattern_name, description, 
               trigger_conditions JSONB, observed_effect JSONB, recommendations JSONB,
               confidence_score, occurrence_count, active, last_observed_at)

-- Conversation history for mAIstro context
conversations (id, user_id, role, message, context JSONB, mood_score, intent, created_at)

-- AI orchestration decision tracking
ai_orchestration_sessions (id, user_id, session_type, mood_score, schedule_density,
                            ai_decisions JSONB, recommendations JSONB, user_selected_action)

-- User feedback for continuous improvement
user_feedback (id, user_id, feedback_type, target_id, rating, comment, context JSONB)
```

### Views
```sql
-- Complete user state in one query
user_current_state (id, email, name, display_name, neuro_preferences, 
                     personality_traits, last_mood_check_in, last_active)

-- 30-day mood trends with aggregations
mood_trends (user_id, date, avg_mood_score, avg_energy_level, check_in_count)
```

### Schema Organization Principles
1. **JSONB for evolving data**: Use for `profile_data`, `plan_data` to avoid migrations
2. **Explicit tables for analytics**: Track completions, intensity for insights
3. **Caching strategy**: Store expensive calculations (intensity, audio URLs)
4. **Indexes on queries**: user_id, dates, created_at for fast lookups
5. **Soft deletes**: Add `deleted_at` for user data retention compliance

### Adding New Tables
```sql
-- Template for new table
CREATE TABLE table_name (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES profiles(user_id) ON DELETE CASCADE,
  -- columns here
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Always add indexes
CREATE INDEX idx_table_name_user_id ON table_name(user_id);
CREATE INDEX idx_table_name_created_at ON table_name(created_at);
```

## When Adding Features

1. **Check design docs first**: Read `DESIGN_PATTERNS.md` for UX constraints
2. **Profile impact**: Does it need new fields in `PersonalNeuroProfile`?
3. **Sensory awareness**: Does it animate, make sound, or flash? Add toggle.
4. **Micro-steps**: If it's an activity, break it into 3-5 concrete actions
5. **API needs**: Backend endpoint? Add route to `server/src/routes/` + update `client/lib/api-client.ts`
6. **TypeScript types**: Update `client/types/neuro-profile.ts` first
7. **Documentation**: Add JSDoc comments and update `server/ARCHITECTURE.md`

## External Resources

- **Server Architecture**: See `server/ARCHITECTURE.md` for modular structure
- **NeuralSeek API**: See `NEURALSEEK_INTEGRATION.md` for embed code auth pattern
- **Supabase**: Run `server/user-schema.sql` for table schemas
- **Expo docs**: https://docs.expo.dev (for notifications, haptics, secure-store)
- **WCAG AAA**: https://www.w3.org/WAI/WCAG21/quickref/ (accessibility reference)
